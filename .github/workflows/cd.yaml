name: CiCi CD
on:
    push:
        tags:
            - v*
env:
    node-version: 20.11.1

permissions:
    contents: write


env:
  VERSION: 1.0.1
jobs:
    desktop-build:
        name: desktop-build
        needs: build_apk
        strategy:
            matrix:
                include:
                    - os: windows-latest
                      command: make:x64
                      tag: x64
                      dist: /apps/desktop/out/make/squirrel.windows/x64/*Setup.exe
        runs-on: ${{ matrix.os }}
        timeout-minutes: 30
            PROJECT_NAME: CiCy
            GITHUB_REPOSITORY: ${{ github.repository }}
            MAKE_OUT_DIR: ${{ github.workspace }}/apps/desktop/out/make
            GH_TOKEN: ${{ github.token }}
        steps:
            - name: Checkout to git repository
              uses: actions/checkout@v4

            - name: Set up Node
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.node-version }}
            - name: Enable Corepack
              run: |
                  corepack enable
            - name: Run install
              uses: borales/actions-yarn@v5
              with:
                  cmd: install
            - name: Build Pkg
              run: |
                  cd ${{ github.workspace }}
                  yarn build:pkg
                  echo "export {App} from '@cc/app';" > apps/desktop/src/app/App.tsx
            - name: Run build distributive
              uses: borales/actions-yarn@v5
              with:
                  cmd: ${{ matrix.command }}
                  dir: 'apps/desktop'
            - name: Release Upload assets on Win32
              if: runner.os == 'Windows'
              env:
                  tag: ${{ github.ref_name }}
              run: |
                  #gh release upload ${{ github.ref_name }} "${{env.MAKE_OUT_DIR}}/zip/win32/x64/${{env.PROJECT_NAME}}-win32-x64-${{env.VERSION}}.zip"
                  mv "${{env.MAKE_OUT_DIR}}/squirrel.windows/x64/${{env.PROJECT_NAME}}-${{env.VERSION}} Setup.exe" "${{env.MAKE_OUT_DIR}}/squirrel.windows/x64/${{env.PROJECT_NAME}}-win32-x64-${{env.VERSION}} Setup.exe"
                  gh release upload ${{ github.ref_name }} "${{env.MAKE_OUT_DIR}}/squirrel.windows/x64/${{env.PROJECT_NAME}}-win32-x64-${{env.VERSION}} Setup.exe"
    
  build_apk:
    name: Build APK
    runs-on: ubuntu-latest
    needs: build_cc_server_and_connctor
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

     - name: Set up Node
        uses: actions/setup-node@v4
        with:
            node-version: ${{ env.node-version }}
    - name: Enable Corepack
        run: |
            corepack enable

    - name: Run install
        uses: borales/actions-yarn@v5
        with:
            cmd: install
            
    - name: Build Pkg
        run: |
            cd ${{ github.workspace }}
            yarn build:pkg
            cd apps/cc-agent-web
            yarn build
            cd ../../

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: 17

      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper/
          key: ${{ runner.os }}-gradle-${{ hashFiles('apps/cc-agent-adr/**/*.gradle*', 'apps/cc-agent-adr/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew
        run: chmod +x ./apps/cc-agent-adr/gradlew

      - name: Build APK
        working-directory: ./apps/cc-agent-adr
        run: ./gradlew assembleDebug

      - name: Build APK
        working-directory: ./apps/cc-agent-adr
        run: |
          ./gradlew assembleDebug
          mv ./apps/cc-agent-adr/app/build/outputs/apk/debug/app-debug.apk ./apps/cc-agent-adr/app/build/outputs/apk/debug/app-${{env.VERSION}}.apk
          gh release upload ${{ github.ref_name }} ./apps/cc-agent-adr/app/build/outputs/apk/debug/app-${{env.VERSION}}.apk

  build_cc_server_and_connctor:
    runs-on: windows-latest
    needs: release
    strategy:
      matrix:
        target:
          - x86_64-pc-windows-msvc
          - i686-pc-windows-msvc
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust target
        run: rustup target add ${{ matrix.target }}

      - name: Download Npcap SDK
        shell: powershell
        run: |
          Invoke-WebRequest -Uri "https://npcap.com/dist/npcap-sdk-1.15.zip" -OutFile "npcap-sdk.zip"
          Expand-Archive -Path "npcap-sdk.zip" -DestinationPath "$env:USERPROFILE\\npcap-sdk-1.15"
      - name: Set environment for Npcap
        shell: powershell
        run: |
          $NpcapPath = "$env:USERPROFILE\\npcap-sdk-1.15"
          echo "INCLUDE=$NpcapPath\\Include" | Out-File -Append $env:GITHUB_ENV

          if ($env:TARGET -eq "i686-pc-windows-msvc") {
            echo "LIB=$NpcapPath\\Lib" | Out-File -Append $env:GITHUB_ENV
          } else ($env:TARGET -eq "x86_64-pc-windows-msvc") {
            echo "LIB=$NpcapPath\\Lib\\x64" | Out-File -Append $env:GITHUB_ENV
          }
          
      - name: Build cici-server
        shell: powershell
        env:
          TARGET: ${{ matrix.target }}
        run: |
          mkdir assets
          $ARTIFACT_NAME = "cici-server"
          Set-Location "apps-rust/$ARTIFACT_NAME"
          cargo build --target $env:TARGET --release
          cd ../../
          $BUILT_PATH = "target/$env:TARGET/release/$ARTIFACT_NAME.exe"
          if (!(Test-Path $BUILT_PATH)) {
            Write-Error "Build output not found at $BUILT_PATH"
            exit 1
          }

          if ($env:TARGET -eq "i686-pc-windows-msvc") {
            $TARGET_NAME = "i686"
          } else ($env:TARGET -eq "x86_64-pc-windows-msvc") {
            $TARGET_NAME = "x86_64"
          }
          $OUTPUT_NAME = "target/$env:TARGET/release/$ARTIFACT_NAME-v${{evn.VERSION}}.exe"
          echo $OUTPUT_NAME
          Copy-Item $BUILT_PATH $OUTPUT_NAME
          gh release upload $OUTPUT_NAME

          
      - name: Build cc-connector-android
        shell: powershell
        env:
          TARGET: ${{ matrix.target }}
        run: |
          mkdir assets
          $ARTIFACT_NAME = "cc-connector-android"
          Set-Location "apps-rust/$ARTIFACT_NAME"
          cargo build --target $env:TARGET --release
          $VERSION = (Select-String -Path Cargo.toml -Pattern '^version =' | Select-Object -First 1).Line -replace '.*version = "(.*)".*','$1'
          Write-Host "Version: $VERSION"
          cd ../../
          $BUILT_PATH = "target/$env:TARGET/release/$ARTIFACT_NAME.exe"
          if (!(Test-Path $BUILT_PATH)) {
            Write-Error "Build output not found at $BUILT_PATH"
            exit 1
          }

          if ($env:TARGET -eq "i686-pc-windows-msvc") {
            $TARGET_NAME = "i686"
          } if ($env:TARGET -eq "x86_64-pc-windows-msvc") {
            $TARGET_NAME = "x86_64"
          } 

          $OUTPUT_NAME = "target/$env:TARGET/release/$ARTIFACT_NAME-v${{evn.VERSION}}.exe"
          echo $OUTPUT_NAME
          Copy-Item $BUILT_PATH $OUTPUT_NAME
          gh release upload $OUTPUT_NAME

    release:
        name: Release pushed tag
        runs-on: ubuntu-22.04
        steps:
            - name: Create release
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  tag: ${{ github.ref_name }}
              run: |
                  if gh release view "$tag" --repo="$GITHUB_REPOSITORY" &> /dev/null; then
                    echo "Release $tag already exists."
                  else
                    gh release create "$tag" \
                        --repo="$GITHUB_REPOSITORY" \
                        --title="${tag}" \
                        --draft \
                        --generate-notes
                    echo "Release $tag created."
                  fi


  build_cc_server_and_connctor
    name: Build cc_server_and_connctor for macOS Intel and ARM
    runs-on: macos-latest
    needs: release
    strategy:
      matrix:
        - x86_64-apple-darwin
        - aarch64-apple-darwin
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust target
        run: rustup target add ${{ matrix.target }}

      - name: Build cici-server
        run: |
          ARTIFACT_NAME=cici-server
          cd apps-rust/$ARTIFACT_NAME
          cargo build --target ${{ matrix.target }} --release
          cd ../../
          BUILT_PATH=target/${{ matrix.target }}/release/$ARTIFACT_NAME
          if [[ "${{ matrix.target }}" == "x86_64-apple-darwin" ]]; then
            TARGET_NAME=x86_64
          elif [[ "${{ matrix.target }}" == "aarch64-apple-darwin" ]]; then
            TARGET_NAME=arm64
          fi
          OUTPUT_NAME=target/${{ matrix.target }}/release/$ARTIFACT_NAME-$TARGET_NAME-v${{env.VERSION}}
          cp "$BUILT_PATH" "assets/$OUTPUT_NAME"

      - name: Build cc-connector-android
        run: |
          ARTIFACT_NAME=cc-connector-android
          cd apps-rust/$ARTIFACT_NAME
          cargo build --target ${{ matrix.target }} --release
          cd ../../
          BUILT_PATH=target/${{ matrix.target }}/release/$ARTIFACT_NAME
          if [[ "${{ matrix.target }}" == "x86_64-apple-darwin" ]]; then
            TARGET_NAME=x86_64
          elif [[ "${{ matrix.target }}" == "aarch64-apple-darwin" ]]; then
            TARGET_NAME=arm64
          fi
          OUTPUT_NAME=target/${{ matrix.target }}/release/$ARTIFACT_NAME-$TARGET_NAME-v${{env.VERSION}}
          cp "$BUILT_PATH" $OUTPUT_NAME

    build-cc-agent-rust:
    name: Build cc agent rust
    runs-on: ubuntu-latest

    strategy:
      matrix:
        target:
          - armv7a-linux-androideabi   # armeabi-v7a
          - aarch64-linux-android     # arm64-v8a
          - x86_64-linux-android      # x86_64

    env:
      ANDROID_NDK_VERSION: 27.2.12479018
      CARGO_TERM_COLOR: always

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

        # âœ… Cache Cargo dependencies
      - name: Cache Cargo registry and build
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.target }}-


      - name: Install Rust target
        run: rustup target add ${{ matrix.target }}

      - name: Set up Java (required for sdkmanager)
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
    
      - name: Cache Android NDK
        uses: actions/cache@v3
        with:
          path: ${{ env.ANDROID_HOME }}/ndk/${{ env.ANDROID_NDK_VERSION }}
          key: ndk-${{ env.ANDROID_NDK_VERSION }}

      - name: Install NDK if not cached
        run: |
          if [ ! -d "$ANDROID_HOME/ndk/$ANDROID_NDK_VERSION" ]; then
            sdkmanager --install "ndk;$ANDROID_NDK_VERSION"
          else
            echo "NDK already cached."
          fi

      - name: Set environment for ${{ matrix.target }}
        run: |
          export TOOLCHAIN=$ANDROID_HOME/ndk/${ANDROID_NDK_VERSION}/toolchains/llvm/prebuilt/linux-x86_64/bin
          export API=33
          if [[ "${{ matrix.target }}" == "aarch64-linux-android" ]]; then
            echo "CC_aarch64_linux_android=$TOOLCHAIN/aarch64-linux-android$API-clang" >> $GITHUB_ENV
            echo "AR_aarch64_linux_android=$TOOLCHAIN/llvm-ar" >> $GITHUB_ENV
          elif [[ "${{ matrix.target }}" == "armv7a-linux-androideabi" ]]; then
            echo "CC_armv7a_linux_androideabi=$TOOLCHAIN/armv7-linux-androideabi$API-clang" >> $GITHUB_ENV
            echo "AR_armv7a_linux_androideabi=$TOOLCHAIN/llvm-ar" >> $GITHUB_ENV
          elif [[ "${{ matrix.target }}" == "x86_64-linux-android" ]]; then
            echo "CC_x86_64_linux_android=$TOOLCHAIN/x86_64-linux-android$API-clang" >> $GITHUB_ENV
            echo "AR_x86_64_linux_android=$TOOLCHAIN/llvm-ar" >> $GITHUB_ENV
          fi
          # Set linker and rustflags
          linker_path="$TOOLCHAIN/${{ matrix.target }}$API-clang"
          target_env_key="CARGO_TARGET_$(echo '${{ matrix.target }}' | tr a-z A-Z | tr '-' '_')_LINKER"
          echo "$target_env_key=$linker_path" >> $GITHUB_ENV
          echo "RUSTFLAGS=-C link-arg=--sysroot=$ANDROID_HOME/ndk/${ANDROID_NDK_VERSION}/toolchains/llvm/prebuilt/linux-x86_64/sysroot" >> $GITHUB_ENV

      - name: Build with cargo for ${{ matrix.target }}
        run: |
          cd apps-rust/cc-agent-rust
          cargo build --target=${{ matrix.target }} --release
          cd ../../

      - name: Copy build output to assets with version
        run: |
          ARTIFACT_NAME=cc-agent-rust
          BUILT_PATH=target/${{ matrix.target }}/release/$ARTIFACT_NAME

          if [[ "${{ matrix.target }}" == "aarch64-linux-android" ]]; then
            TARGET_NAME=arm64
          elif [[ "${{ matrix.target }}" == "armv7-linux-androideabi" ]]; then
            TARGET_NAME=armv7a
          elif [[ "${{ matrix.target }}" == "x86_64-linux-android" ]]; then
            TARGET_NAME=x86_64
          fi
          BUILT_PATH=target/${{ matrix.target }}/release/$ARTIFACT_NAME-$TARGET_NAME-${{env.VERSION}}
          cp "$BUILT_PATH" "assets/$OUTPUT_NAME"

